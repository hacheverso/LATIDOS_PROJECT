generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Double Layer Inventory System + Type Precision Traceability

model Product {
  id          String   @id @default(uuid())
  name        String
  sku         String   @unique
  upc         String   @unique // Universal Product Code
  category    String?   // Legacy string, transitioning to relation
  categoryId  String?
  categoryRel Category? @relation(fields: [categoryId], references: [id])
  basePrice   Decimal  @default(0)
  state       String   @default("Nuevo")
  imageUrl    String?
  
  // Relations
  instances   Instance[]
  priceHistory PriceHistory[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("products")
}

model Category {
  id          String    @id @default(uuid())
  name        String    @unique
  slug        String?   @unique
  products    Product[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("categories")
}

model PriceHistory {
  id          String   @id @default(uuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  oldPrice    Decimal
  newPrice    Decimal
  reason      String?  // e.g., "Strategy Update", "Slow Rotation"
  
  createdAt   DateTime @default(now())

  @@map("price_history")
}

model Supplier {
  id          String   @id @default(uuid())
  name        String
  nit         String   @unique // Tax ID
  contactName String?
  phone       String?
  email       String?
  address     String?
  
  purchases   Purchase[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("suppliers")
}

model Purchase {
  id          String   @id @default(uuid())
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id])
  
  date        DateTime @default(now())
  receptionNumber String? @unique // YYMM####
  status      String @default("DRAFT")
  totalCost   Decimal
  currency    String   @default("COP")
  exchangeRate Decimal @default(1)
  notes       String?

  instances   Instance[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("purchases")
}

model Instance {
  id           String         @id @default(uuid())
  productId    String
  product      Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  purchaseId   String?
  purchase     Purchase?      @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  // Unique Identifiers
  serialNumber String?        @unique
  imei         String?        @unique
  
  // State & Financials
  status       String @default("IN_STOCK")
  condition    String @default("NEW")
  cost         Decimal? // Unit Cost
  soldPrice    Decimal? // Transaction Price (if sold)
  originalCost Decimal? // Original Input Cost
  location     String?        // e.g., "Warehouse A", "Store Front"
  
  // ... inside Instance
  saleId       String?
  sale         Sale?          @relation(fields: [saleId], references: [id])

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@map("instances")
}

model Customer {
  id          String   @id @default(uuid())
  name        String
  taxId       String   @unique // ID Document / NIT
  email       String?
  phone       String?
  address     String?

  sales       Sale[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("customers")
}

model Sale {
  id            String   @id @default(uuid())
  
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id])
  
  date          DateTime @default(now())
  total         Decimal
  amountPaid    Decimal  @default(0)
  paymentMethod String   @default("EFECTIVO") // EFECTIVO, TRANSFERENCIA, NOTA CRÃ‰DITO, RETOMA
  
  invoiceNumber String?  @unique // YYYYMM###
  notes         String?

  instances     Instance[]
  payments      Payment[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("sales")
}

model Payment {
  id            String   @id @default(uuid())
  saleId        String
  sale          Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  
  amount        Decimal
  date          DateTime @default(now())
  method        String   @default("EFECTIVO")
  reference     String?
  notes         String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("payments")
}


model OrganizationProfile {
  id          String   @id @default(uuid())
  name        String   @default("Mi Negocio")
  nit         String   @default("000000000")
  address     String?
  phone       String?
  email       String?
  website     String?
  logoUrl     String?
  footerMsg   String?  @default("Gracias por su compra")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("organization_profile")
}
