generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Double Layer Inventory System + Type Precision Traceability

model Product {
  id          String   @id @default(uuid())
  name        String
  sku         String   @unique
  upc         String   @unique // Universal Product Code
  category    String?   // Legacy string, transitioning to relation
  categoryId  String?
  categoryRel Category? @relation(fields: [categoryId], references: [id])
  basePrice   Decimal  @default(0)
  state       String   @default("Nuevo")
  imageUrl    String?
  
  // Relations
  instances   Instance[]
  priceHistory PriceHistory[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("products")
}

model Category {
  id          String    @id @default(uuid())
  name        String    @unique
  slug        String?   @unique
  products    Product[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("categories")
}

model PriceHistory {
  id          String   @id @default(uuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  oldPrice    Decimal
  newPrice    Decimal
  reason      String?  // e.g., "Strategy Update", "Slow Rotation"
  
  createdAt   DateTime @default(now())

  @@map("price_history")
}

model Supplier {
  id          String   @id @default(uuid())
  name        String
  nit         String   @unique // Tax ID
  contactName String?
  phone       String?
  email       String?
  address     String?
  
  purchases   Purchase[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("suppliers")
}

model Purchase {
  id          String   @id @default(uuid())
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id])
  
  date        DateTime @default(now())
  receptionNumber String? @unique // YYMM####
  status      String @default("DRAFT")
  totalCost   Decimal
  currency    String   @default("COP")
  exchangeRate Decimal @default(1)
  notes       String?
  attendant   String   @default("ADMIN") // Person in charge

  instances   Instance[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("purchases")
}

model Instance {
  id           String         @id @default(uuid())
  productId    String
  product      Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  purchaseId   String?
  purchase     Purchase?      @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  // Unique Identifiers
  serialNumber String?        @unique
  imei         String?        @unique
  
  // State & Financials
  status       String @default("IN_STOCK")
  condition    String @default("NEW")
  cost         Decimal? // Unit Cost
  soldPrice    Decimal? // Transaction Price (if sold)
  originalCost Decimal? // Original Input Cost
  location     String?        // e.g., "Warehouse A", "Store Front"
  
  // ... inside Instance
  saleId       String?
  sale         Sale?          @relation(fields: [saleId], references: [id])

  adjustmentId String?
  adjustment   StockAdjustment? @relation(fields: [adjustmentId], references: [id])

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@map("instances")
}

model Customer {
  id          String   @id @default(uuid())
  name        String
  taxId       String   @unique // ID Document / NIT
  email       String?
  phone       String?
  address     String?
  creditBalance Decimal @default(0)

  sales       Sale[]
  tasks       LogisticsTask[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("customers")
}

model Sale {
  id            String   @id @default(uuid())
  
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id])
  
  date          DateTime @default(now())
  total         Decimal
  amountPaid    Decimal  @default(0)
  paymentMethod String   @default("EFECTIVO") // EFECTIVO, TRANSFERENCIA, NOTA CRÉDITO, RETOMA
  
  invoiceNumber String?  @unique // YYYYMM###
  notes         String?

  instances     Instance[]
  payments      Payment[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Logistics
  deliveryMethod String   @default("DELIVERY") // DELIVERY | PICKUP
  deliveryStatus String   @default("PENDING")  // PENDING | ON_ROUTE | DELIVERED
  urgency        Urgency  @default(MEDIUM)
  
  assignedToId   String?
  assignedTo     User?    @relation("SaleDriver", fields: [assignedToId], references: [id])
  
  // Logistics History Metrics
  onRouteAt      DateTime?
  completedAt    DateTime?
  evidenceUrl    String?

  // Audit
  lastModifiedBy String?
  modificationReason String?
  audits        SaleAudit[]

  @@map("sales")
}

enum Urgency {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model LogisticsTask {
  id          String   @id @default(uuid())
  title       String
  description String?
  address     String?
  moneyToCollect Decimal @default(0)
  
  urgency     Urgency  @default(MEDIUM)
  status      String   @default("PENDING") // PENDING, ON_ROUTE, COMPLETED

  assignedToId String?
  assignedTo   User?     @relation("TaskDriver", fields: [assignedToId], references: [id])
  customer     Customer? @relation(fields: [customerId], references: [id])
  customerId   String?

  // Logistics History Metrics
  onRouteAt    DateTime?
  completedAt  DateTime?
  evidenceUrl  String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("logistics_tasks")
}

enum Role {
  ADMIN
  STAFF
  DOMICILIARIO
}

enum UserStatus {
  PENDING
  ACTIVE
  INACTIVE
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  password  String?   // Hashed (Optional now, as it's set later)
  pin       String?   @unique // Deprecated
  securityPin String? // Hashed PIN (Optional now)
  
  status            UserStatus @default(ACTIVE)
  invitationToken   String?    @unique
  invitationExpires DateTime?

  role      Role     @default(STAFF)
  permissions Json?  // { canEditSales: boolean, ... }

  // Profile Fields
  phone     String?
  address   String?
  imageUrl  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  audits    SaleAudit[]
  
  // Logistics
  deliveries Sale[] @relation("SaleDriver")
  tasks      LogisticsTask[] @relation("TaskDriver")
  
  stockAdjustments StockAdjustment[]

  @@map("users")
}

model SaleAudit {
  id        String   @id @default(uuid())
  
  saleId    String
  sale      Sale     @relation(fields: [saleId], references: [id])
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  userName  String? // Snapshot
  
  reason    String
  changes   Json    // Structured diff
  
  createdAt DateTime @default(now())

  @@map("sale_audits")
}

model Payment {
  id            String   @id @default(uuid())
  saleId        String
  sale          Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  
  amount        Decimal
  date          DateTime @default(now())
  method        String   @default("EFECTIVO")
  reference     String?
  notes         String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("payments")
}


model OrganizationProfile {
  id          String   @id @default(uuid())
  name        String   @default("Mi Negocio")
  nit         String   @default("000000000")
  address     String?
  phone       String?
  email       String?
  website     String?
  logoUrl     String?
  footerMsg   String?  @default("Gracias por su compra")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("organization_profile")
}

model Sequence {
  id        String @id @default(uuid())
  type      String // "SALE" or "PURCHASE"
  year      Int
  current   Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([type, year])
  @@map("sequences")
}

model StockAdjustment {
  id          String   @id @default(uuid())
  
  quantity    Int      // Positive (Add) or Negative (Remove)
  reason      String
  category    String   // "Daño", "Pérdida", etc.
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  instances   Instance[]

  createdAt   DateTime @default(now())

  @@map("stock_adjustments")
}
